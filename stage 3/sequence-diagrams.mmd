%% Mermaid sequence diagrams for key use cases

sequenceDiagram
    title 1) Consumer Places an Order & Pays
    participant C as Consumer (Browser)
    participant FE as Frontend Web App
    participant API as Django REST API
    participant DB as PostgreSQL
    participant PAY as Moyasar

    C->>FE: Select products & quantities
    C->>FE: Click "Checkout"
    FE->>API: POST /api/orders/ (cart, farm_id)
    API->>DB: Validate products & capacity
    DB-->>API: OK (capacity available)
    API->>DB: Create Order & OrderItems (status=PENDING)
    API->>PAY: Create payment (amount, order_id)
    PAY-->>API: Payment URL / payment_id
    API-->>FE: 201 Created (order, payment_url)
    FE-->>C: Redirect to payment page / show payment UI

    C->>PAY: Enter payment details
    PAY-->>API: Webhook (payment success)
    API->>DB: Update Payment (PAID) & Order (CONFIRMED)
    API-->>PAY: 200 OK
    C->>FE: Return to app
    FE->>API: GET /api/orders/{id}
    API->>DB: Fetch order
    DB-->>API: Order (CONFIRMED)
    API-->>FE: Order details
    FE-->>C: Show confirmation screen


sequenceDiagram
    title 2) Farm Owner Manages Products & Capacity
    participant FO as Farm Owner (Browser)
    participant FE as Frontend Web App
    participant API as Django REST API
    participant DB as PostgreSQL

    FO->>FE: Open Dashboard
    FE->>API: GET /api/farms/mine/
    API->>DB: Query farms by owner
    DB-->>API: Farms list
    API-->>FE: Farms JSON
    FE-->>FO: Render dashboard

    FO->>FE: Open Product Management
    FE->>API: GET /api/products?farm={id}
    API->>DB: Query products by farm
    DB-->>API: Product list
    API-->>FE: Products JSON
    FE-->>FO: Show products

    FO->>FE: Create/Update/Delete product
    FE->>API: POST/PATCH/DELETE /api/products/
    API->>DB: Apply change (validate owner)
    DB-->>API: OK
    API-->>FE: Updated product list/confirmation
    FE-->>FO: Show success message

    FO->>FE: Set daily capacity
    FE->>API: POST /api/capacities/ (product_id, date, max_quantity)
    API->>DB: Upsert DailyCapacity
    DB-->>API: OK
    API-->>FE: Capacity saved
    FE-->>FO: Show updated capacity


sequenceDiagram
    title 3) Consumer Views and Tracks Orders
    participant C as Consumer (Browser)
    participant FE as Frontend Web App
    participant API as Django REST API
    participant DB as PostgreSQL

    C->>FE: Open "My Orders"
    FE->>API: GET /api/orders?mine=true
    API->>DB: Query orders by consumer
    DB-->>API: Orders list
    API-->>FE: Orders JSON
    FE-->>C: Render order list with statuses

    C->>FE: Select order
    FE->>API: GET /api/orders/{id}
    API->>DB: Fetch order & items
    DB-->>API: Order + items
    API-->>FE: Order details
    FE-->>C: Show status timeline & details
